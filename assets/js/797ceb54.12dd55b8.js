"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4649],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return u}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=d(n),u=r,h=m["".concat(l,".").concat(u)]||m[u]||p[u]||i;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5830:function(e,t,n){n.r(t),n.d(t,{contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return c}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],s={title:"Integration Testing",sidebar_position:10},l=void 0,d={unversionedId:"integration-testing",id:"integration-testing",isDocsHomePage:!1,title:"Integration Testing",description:"|Lecture equivalent| Duration |",source:"@site/tasks/integration-testing.md",sourceDirName:".",slug:"/integration-testing",permalink:"/swdt/tasks/integration-testing",editUrl:"https://github.com/nds-swe/swdt/edit/main/tasks/integration-testing.md",tags:[],version:"current",lastUpdatedBy:"dependabot[bot]",lastUpdatedAt:1649407389,formattedLastUpdatedAt:"4/8/2022",sidebarPosition:10,frontMatter:{title:"Integration Testing",sidebar_position:10},sidebar:"myAutogeneratedSidebar",previous:{title:"GitHub Actions",permalink:"/swdt/tasks/github-actions"},next:{title:"Spring Starter",permalink:"/swdt/tasks/spring-starter"}},c=[{value:"Add test",id:"add-test",children:[{value:"Refactor <code>EmployeesController</code>",id:"refactor-employeescontroller",children:[],level:3},{value:"First integration test",id:"first-integration-test",children:[],level:3},{value:"Run tests",id:"run-tests",children:[],level:3}],level:2},{value:"Interim report",id:"interim-report",children:[],level:2},{value:"Automate",id:"automate",children:[{value:"Create <code>docker-compose.yml</code>",id:"create-docker-composeyml",children:[],level:3},{value:"Separate unit and integration tests",id:"separate-unit-and-integration-tests",children:[],level:3},{value:"Verification",id:"verification",children:[{value:"Unit Test",id:"unit-test",children:[],level:4},{value:"Integration-Test",id:"integration-test",children:[],level:4}],level:3},{value:"Automate integration testing away",id:"automate-integration-testing-away",children:[],level:3}],level:2},{value:"Scanning our container",id:"scanning-our-container",children:[{value:"Scan your container",id:"scan-your-container",children:[],level:3},{value:"Add the workflow",id:"add-the-workflow",children:[],level:3}],level:2},{value:"Sample",id:"sample",children:[],level:2}],p={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Metadata")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("table",{parentName:"div"},(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Lecture equivalent"),(0,i.kt)("th",{parentName:"tr",align:null},"Duration"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"3"),(0,i.kt)("td",{parentName:"tr",align:null},"2h 15min")))),(0,i.kt)("p",{parentName:"div"},"At the end of this task, students"),(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"have added one integration test (",(0,i.kt)("em",{parentName:"li"},"IT"),") to the spring-starter"),(0,i.kt)("li",{parentName:"ul"},"have added a ",(0,i.kt)("inlineCode",{parentName:"li"},"docker-compose.yml")," file"),(0,i.kt)("li",{parentName:"ul"},"run the integration test in test containers"),(0,i.kt)("li",{parentName:"ul"},"run a docker security scan upon every pull request")))),(0,i.kt)("h2",{id:"add-test"},"Add test"),(0,i.kt)("div",{className:"admonition admonition-warning alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"\ud83e\uddd1\ud83c\udffd\u200d\ud83c\udf93-advice")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"This task combines literally everything you learned until now. Mastering this task requires time and the will to learn, there is no fast-lane. The result will be fascinating, mature and powerful. But if you expect that you can do this by clicking three times in a UI, you did not pay attention the previous 18 lessons."),(0,i.kt)("p",{parentName:"div"},(0,i.kt)("strong",{parentName:"p"},"As a reward for your efforts you get a fully-automated, state-of-the-art CI pipeline using GitHub Actions!")))),(0,i.kt)("h3",{id:"refactor-employeescontroller"},"Refactor ",(0,i.kt)("inlineCode",{parentName:"h3"},"EmployeesController")),(0,i.kt)("p",null,"In the ",(0,i.kt)("a",{parentName:"p",href:"spring-starter"},"spring-starter task")," we created two endpoints, one seemingly secure, the other not secure."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Remove the insecure endpoint. Refactor the secure endpoint to use a layered architecture to fetch three fictional employees.\nRemove also the ",(0,i.kt)("inlineCode",{parentName:"p"},"empty")," endpoints from ",(0,i.kt)("a",{parentName:"p",href:"architecture"},"architecture"),", you also do not need them anymore."),(0,i.kt)("p",{parentName:"div"},"Merge these two tasks (spring-starter and architecture) into one ",(0,i.kt)("inlineCode",{parentName:"p"},"/employees")," endpoint!"))),(0,i.kt)("h3",{id:"first-integration-test"},"First integration test"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Write your first integration test as shown below."))),(0,i.kt)("p",null,"Create a new file: ",(0,i.kt)("inlineCode",{parentName:"p"},"EmployeeControllerTestIT.class")," (the ",(0,i.kt)("em",{parentName:"p"},"IT")," stands for integration test and helps to distinguish files)"),(0,i.kt)("p",null,"Use these sources to write your first own integration test (you can also cheat, learning nothing):"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://rest-assured.io/"},"https://rest-assured.io/")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/rest-assured/rest-assured/wiki/GettingStarted#rest-assured"},"https://github.com/rest-assured/rest-assured/wiki/GettingStarted#rest-assured")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/rest-assured/rest-assured/wiki/Usage#challenged-basic-authentication"},"https://github.com/rest-assured/rest-assured/wiki/Usage#challenged-basic-authentication")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/rest-assured/rest-assured/wiki/Usage#root-path"},"https://github.com/rest-assured/rest-assured/wiki/Usage#root-path")," --\x3e last example")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"note ",(0,i.kt)("inlineCode",{parentName:"li"},'body("size()", equalTo(4)).'))),(0,i.kt)("p",null,"Compose these sources into one test. Try as hard as you can, before you cheat."),(0,i.kt)("h3",{id:"run-tests"},"Run tests"),(0,i.kt)("p",null,"First, make sure that your old EmployeeTest (from ",(0,i.kt)("a",{parentName:"p",href:"github-actions"},"github-actions"),") still works. If the old test still passes, run the new test."),(0,i.kt)("p",null,"You will hit:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"java.net.ConnectException: Connection refused\n\n    at java.base/sun.nio.ch.Net.connect0(Native Method)\n    at java.base/sun.nio.ch.Net.connect(Net.java:503)\n    at java.base/sun.nio.ch.Net.connect(Net.java:492)\n...\n")),(0,i.kt)("p",null,"Why?"),(0,i.kt)("div",{className:"admonition admonition-success alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"success")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Integration test test against a running instance! So you need your server running at the same time as the tests to succeed!"))),(0,i.kt)("p",null,"So, in IntelliJ (or the console), start the server, then run the tests (IntelliJ can handle that, yes)."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Make your tests success the first time! All of them"),(0,i.kt)("ul",{parentName:"div"},(0,i.kt)("li",{parentName:"ul"},"EmployeeTest.java"),(0,i.kt)("li",{parentName:"ul"},"EmployeeControllerTestIT.java")),(0,i.kt)("p",{parentName:"div"},"In order for this to work properly, you might give a look at ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/nds-swe/jinder/pull/7"},"JUnit 5 Test Tagging"),"."))),(0,i.kt)("h2",{id:"interim-report"},"Interim report"),(0,i.kt)("p",null,"Congrats, you have made it quite far! Now lets automate some things away!"),(0,i.kt)("h2",{id:"automate"},"Automate"),(0,i.kt)("h3",{id:"create-docker-composeyml"},"Create ",(0,i.kt)("inlineCode",{parentName:"h3"},"docker-compose.yml")),(0,i.kt)("p",null,"We have seen in the lecture and you can read up ",(0,i.kt)("a",{parentName:"p",href:"https://docs.docker.com/compose/compose-file/"},"here")," what a ",(0,i.kt)("inlineCode",{parentName:"p"},"docker-compose.yml")," file does."),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Add a docker compose definition to your project. You can either fill it in yourself or see its content ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/nds-swe/spring-starter/blob/main/docker-compose.yml"},"here"),"."))),(0,i.kt)("p",null,"This compose file will be used by a gradle plugin to ",(0,i.kt)("inlineCode",{parentName:"p"},"up")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"down")," your project automatically during test phase! No more manually starting the project!"),(0,i.kt)("h3",{id:"separate-unit-and-integration-tests"},"Separate unit and integration tests"),(0,i.kt)("p",null,"Modify your gradle test task to look like so:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-gradle"},'test {\n    useJUnitPlatform{\n        includeTags \'unit\'\n        excludeTags \'IT\'\n    }\n    testLogging {\n        events "passed", "skipped", "failed"\n    }\n}\n')),(0,i.kt)("p",null,"This will only run unit tests when ",(0,i.kt)("inlineCode",{parentName:"p"},"test")," is called. Now it is time to modify our gradle file further, add the following content (there is already a ",(0,i.kt)("inlineCode",{parentName:"p"},"plugins")," section, merge them):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-gradle"},"plugins {\n    id 'com.avast.gradle.docker-compose' version \"0.14.3\"\n    ...\n}\n\ntask integrationTest(type: Test) {\n  dependsOn assemble\n    description = 'Runs integration tests.'\n    group = 'verification'\n    useJUnitPlatform{\n            includeTags 'IT'\n            excludeTags 'unit'\n    }\n    testLogging {\n            events \"passed\", \"skipped\", \"failed\"\n    }\n}\n\ndockerCompose.isRequiredBy(integrationTest)\n")),(0,i.kt)("p",null,"You find a full ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/nds-swe/spring-starter/blob/main/build.gradle"},"example")," here. Let us check what each line does:"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Statement"),(0,i.kt)("th",{parentName:"tr",align:null},"Function"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"plugins --\x3e id 'com.avast.gradle.docker-compose' version \"0.14.3\"")),(0,i.kt)("td",{parentName:"tr",align:null},"Imports the gradle plugin to use docker-compose")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"task integrationTest(type: Test)")),(0,i.kt)("td",{parentName:"tr",align:null},"Defines a new task of type ",(0,i.kt)("inlineCode",{parentName:"td"},"Test")," (and we want to run tests)")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"dependsOn assemble")),(0,i.kt)("td",{parentName:"tr",align:null},"Before we can build the ",(0,i.kt)("inlineCode",{parentName:"td"},"Dockerfile")," (using compose), we must assemble (build without test) our application")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"description = 'Runs integration tests.'")),(0,i.kt)("td",{parentName:"tr",align:null},"Self-explaining")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"group = 'verification'")),(0,i.kt)("td",{parentName:"tr",align:null},"Self-explaining")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"useJUnitPlatform")),(0,i.kt)("td",{parentName:"tr",align:null},"Already seen in unit tests only this time we switch the include and exclude")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"testLogging")),(0,i.kt)("td",{parentName:"tr",align:null},"Log level, known from unit tests")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("inlineCode",{parentName:"td"},"dockerCompose.isRequiredBy(integrationTest)")),(0,i.kt)("td",{parentName:"tr",align:null},"Instructing gradle, that ",(0,i.kt)("inlineCode",{parentName:"td"},"dockerCompose")," is required for ",(0,i.kt)("inlineCode",{parentName:"td"},"integrationTest"))))),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Add the fully-automated integration tests as described above."))),(0,i.kt)("h3",{id:"verification"},"Verification"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Run the tests locally, make sure they run. It will look something like shown below."))),(0,i.kt)("h4",{id:"unit-test"},"Unit Test"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f ./gradlew test\nStarting a Gradle Daemon, 1 stopped Daemon could not be reused, use --status for details\n\n> Task :test\n\nEmployeeTest > Is too young PASSED\n\nEmployeeTest > Old enough PASSED\n\nEmployeeTest > Of exact age PASSED\n\nStarterApplicationTests > contextLoads() PASSED\n\nBUILD SUCCESSFUL in 10s\n4 actionable tasks: 1 executed, 3 up-to-date\n")),(0,i.kt)("h4",{id:"integration-test"},"Integration-Test"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"\u276f ./gradlew integrationTest\n\n> Task :compileJava\nNote: /Users/i511895/SAPDevelop/abb/spring-starter/src/main/java/ch/abbts/nds/swe/swdt/starter/CustomWebSecurityConfigurerAdapter.java uses or overrides a deprecated API.\nNote: Recompile with -Xlint:deprecation for details.\n\n> Task :composeUp\nBuilding spring-starter\n#1 [internal] load build definition from Dockerfile\n#1 sha256:e1337714ae876a631a3bf45c92f841420367f90eb30d6ef5373ed94e28a5a64e\n#1 transferring dockerfile: 243B 0.0s done\n#1 DONE 0.0s\n\n#2 [internal] load .dockerignore\n#2 sha256:32fbaf5926bedad3eaba22b0a79f92ce2d11f6f2df2a01d5052dbe2441255ebf\n#2 transferring context: 2B done\n#2 DONE 0.0s\n\n#3 [internal] load metadata for docker.io/azul/zulu-openjdk-alpine:16\n#3 sha256:ec9410ded58039807916e8fe0a299ec3a2e7197e9b0ce752e04977d6f91dfe97\n#3 ...\n\n#4 [auth] azul/zulu-openjdk-alpine:pull token for registry-1.docker.io\n#4 sha256:c704e25d5a25d2c7d3b59d36e5eeda887364ca8b5c1c6e4866fc4573ec2e7ef4\n#4 DONE 0.0s\n\n#3 [internal] load metadata for docker.io/azul/zulu-openjdk-alpine:16\n#3 sha256:ec9410ded58039807916e8fe0a299ec3a2e7197e9b0ce752e04977d6f91dfe97\n#3 DONE 1.5s\n\n#5 [1/3] FROM docker.io/azul/zulu-openjdk-alpine:16@sha256:c7ccaaba7dfac3f2f921122a9afc857938a451f740d3c9afb53499016ce344ab\n#5 sha256:4c6ecb1d4dc6e3734acab6b473c1584d377df5560c68a0fd37bd8fcb3637e821\n#5 DONE 0.0s\n\n#7 [internal] load build context\n#7 sha256:66222cb7c1cd63d64d2d6c03cc5be835c62af9503e3779f1348b97b70b3cc291\n#7 transferring context: 22.40MB 0.6s done\n#7 DONE 0.6s\n\n#6 [2/3] RUN addgroup -S spring && adduser -S spring -G spring\n#6 sha256:cbc1aef0ebe6c25c05bb97ef259dce0878a1b5b7adc7d98c911892cc573b2b4f\n#6 CACHED\n\n#8 [3/3] COPY build/libs/*T.jar app.jar\n#8 sha256:41507ef1965217d13258fab725d0c5ea680134611cff7125f3d7562e1227f9cc\n#8 DONE 0.1s\n\n#9 exporting to image\n#9 sha256:e8c613e07b0b7ff33893b694f7759a10d42e180f2b4dc349fb57dc6b71dcab00\n#9 exporting layers 0.1s done\n#9 writing image sha256:a185e2bafb07a0d69fcb64b4b07cd5d5d7b775358b7e61f4929e1ff9109e7857 done\n#9 naming to docker.io/library/ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter done\n#9 DONE 0.1s\nCreating network \"ab4f8ff4365c3530a6e3290494e6ed02_starter__default\" with the default driver\nCreating ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ...\nCreating ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ... done\nDocker Compose is now in the Docker CLI, try `docker compose up`\n\nWill use localhost as host of spring-starter\nMore forwarded TCP ports for service 'spring-starter:8080 [[HostIp:0.0.0.0, HostPort:8080], [HostIp:::, HostPort:8080]]'. Will use the first one.\nProbing TCP socket on localhost:8080 of 'spring-starter_1'\nWaiting for TCP socket on localhost:8080 of 'spring-starter_1' (TCP connection on localhost:8080 of 'spring-starter_1' was disconnected right after connected)\nWill use localhost as host of spring-starter\nMore forwarded TCP ports for service 'spring-starter:8080 [[HostIp:0.0.0.0, HostPort:8080], [HostIp:::, HostPort:8080]]'. Will use the first one.\nWaiting for TCP socket on localhost:8080 of 'spring-starter_1' (TCP connection on localhost:8080 of 'spring-starter_1' was disconnected right after connected)\nWill use localhost as host of spring-starter\nMore forwarded TCP ports for service 'spring-starter:8080 [[HostIp:0.0.0.0, HostPort:8080], [HostIp:::, HostPort:8080]]'. Will use the first one.\nWaiting for TCP socket on localhost:8080 of 'spring-starter_1' (TCP connection on localhost:8080 of 'spring-starter_1' was disconnected right after connected)\nWill use localhost as host of spring-starter\nMore forwarded TCP ports for service 'spring-starter:8080 [[HostIp:0.0.0.0, HostPort:8080], [HostIp:::, HostPort:8080]]'. Will use the first one.\nWaiting for TCP socket on localhost:8080 of 'spring-starter_1' (TCP connection on localhost:8080 of 'spring-starter_1' was disconnected right after connected)\nWill use localhost as host of spring-starter\nMore forwarded TCP ports for service 'spring-starter:8080 [[HostIp:0.0.0.0, HostPort:8080], [HostIp:::, HostPort:8080]]'. Will use the first one.\nTCP socket on localhost:8080 of 'spring-starter_1' is ready\n+------------------+----------------+----------------+\n| Name             | Container Port | Mapping        |\n+------------------+----------------+----------------+\n| spring-starter_1 | 8080           | localhost:8080 |\n+------------------+----------------+----------------+\n\n> Task :integrationTest\n\nEmployeeControllerTestIT > /employees/ returns 200 and a 3 employees PASSED\n\n> Task :composeDown\nStopping ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ...\nStopping ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ... done\nRemoving ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ...\nRemoving ab4f8ff4365c3530a6e3290494e6ed02_starter__spring-starter_1 ... done\nRemoving network ab4f8ff4365c3530a6e3290494e6ed02_starter__default\n\nBUILD SUCCESSFUL in 33s\n9 actionable tasks: 9 executed\n")),(0,i.kt)("p",null,"Observe what happens above:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Docker Compose ",(0,i.kt)("inlineCode",{parentName:"li"},"ups")," (starts) your backend"),(0,i.kt)("li",{parentName:"ol"},"JUnit runs your integration tests against the new container"),(0,i.kt)("li",{parentName:"ol"},"Docker Compose turns your container off")),(0,i.kt)("div",{className:"admonition admonition-success alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"F",(0,i.kt)("strong",{parentName:"h5"},"*")," amazing")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You literally mastered the most difficult part of our lecture \ud83c\udf89\ud83c\udf7b\ud83e\udd42 This technology is so fascinating!"))),(0,i.kt)("h3",{id:"automate-integration-testing-away"},"Automate integration testing away"),(0,i.kt)("p",null,"You know what is missing don't you... Automate the test running away!"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Change your GitHub Action Workflow. Make it run both tests in two different ",(0,i.kt)("inlineCode",{parentName:"p"},"jobs")," (it can do that know thanks to your work before!)."))),(0,i.kt)("h2",{id:"scanning-our-container"},"Scanning our container"),(0,i.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"Task")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"You learned in Lesson 6 how container scanning works. You have attended multiple lessons that run GitHub Actions. Setup another workflow, that runs every sunday night and upon every Pull Request and scans your docker image for vulnerabilities."))),(0,i.kt)("h3",{id:"scan-your-container"},"Scan your container"),(0,i.kt)("p",null,"First, scan your container, you will find a ton of vulnerabilities. Switch the base image to ",(0,i.kt)("inlineCode",{parentName:"p"},"azul/zulu-openjdk-alpine:16")," to get rid of most of them."),(0,i.kt)("h3",{id:"add-the-workflow"},"Add the workflow"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yml"},"name: Container Scan\non:\n  schedule:\n    - cron: '0 2 * * 0'\n  pull_request:\n    branches:\n      - main\njobs:\n  scan:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v2\n      - uses: actions/setup-java@v1\n        with:\n          java-version: 11\n      - run: ./gradlew build\n        name: Build application\n      - run: docker build . -t ndshfswe.azurecr.io/spring-starter:${{ github.sha }}\n        name: Build docker image\n      - uses: Azure/container-scan@v0\n        name: Scan docker image\n        with:\n          severity-threshold: MEDIUM\n          image-name: ndshfswe.azurecr.io/spring-starter:${{ github.sha }}\n")),(0,i.kt)("p",null,"Add this point in time, I do expect that you can teach yourself what this file does. Only one point is to note."),(0,i.kt)("p",null,"We use ",(0,i.kt)("inlineCode",{parentName:"p"},"Azure/container-scan")," instead of Snyk because it does not require any token or API and runs locally on our ubuntu runner."),(0,i.kt)("h2",{id:"sample"},"Sample"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/nds-swe/spring-starter/tree/0.1.9"},"Here we go"),"."),(0,i.kt)("p",null,"Note that at the point of writing (28th May 2021) one CVE (CVE-2021-31535) even in the latest Java image. We must await a fix - check the logs here to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/nds-swe/spring-starter/runs/2704432132?check_suite_focus=true"},"see the scans failing"),"."))}m.isMDXComponent=!0}}]);